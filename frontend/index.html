<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8" />
    <title>Projektübersicht</title>
    <link rel="stylesheet" href="StylesCSS/style.css" />
    <style>
        .filter-options select {
            width: 100%;
            padding: 5px;
            margin-top: 5px;
        }
    </style>
</head>
<body>

<header>
    <div class="logo">
        <img src="Bilder/BlueShark.png" alt="Logo" class="logo-image" />
        <span class="logo-text">BlueShark</span>
    </div>
    <nav>
        <a href="index.html" class="active">Home</a>
        <a href="about.html">About</a>
    </nav>
    <input type="search" id="searchInput" placeholder="Projekt suchen..." />
</header>

<main>
    <section class="dashboard"><h2 id="dashboardTitle">Project Dashboard</h2></section>
    <section class="content-area">
        <aside class="filters">
            <h3>Filter</h3>

            <div class="filter-group">
                <button class="filter-toggle">Project</button>
                <div class="filter-options">
                    <select id="projectFilter"><option value="">All Projects</option></select>
                </div>
            </div>

            <div class="filter-group">
                <button class="filter-toggle">Project Leader</button>
                <div class="filter-options">
                    <select id="leaderFilter"><option value="">All Leaders</option></select>
                </div>
            </div>

            <div class="filter-group">
                <button class="filter-toggle">Status</button>
                <div class="filter-options">
                    <label><input type="checkbox" value="On track" /> On track</label><br />
                    <label><input type="checkbox" value="Delayed" /> Delayed</label><br />
                    <label><input type="checkbox" value="Critical" /> Critical</label>
                </div>
            </div>

            <div class="filter-group">
                <button class="filter-toggle">Year</button>
                <div class="filter-options">
                    <label><input type="checkbox" value="2025" /> 2025</label><br />
                    <label><input type="checkbox" value="2024" /> 2024</label><br />
                    <label><input type="checkbox" value="2023" /> 2023</label>
                </div>
            </div>
        </aside>

        <section class="projects-section">
            <div class="status-buttons">
                <button data-status="notStarted">Not Started</button>
                <button data-status="inProgress">In Progress</button>
                <button data-status="completed">Completed</button>
            </div>
            <div class="cards" id="projectCards"></div>
        </section>
    </section>
</main>

<script>
    const statusGroups = {
        completed: ["Z2 - Abgeschlossen"],
        notStarted: ["A1 - Anfrage/Idee"],
        inProgress: [
            "C1 - Umsetzung", "B3 - Planung (Gate 1)", "C2 - Abnahme",
            "F1 - Revision", "B2 - Auftragsklärung (Gate 1)",
            "B5 - Genehmigt (Gate 2)", "B4 - Empfohlen (Gate 1)",
            "A2 - Bewertung (Gate 0)", "B1 - Initiierung (Gate 1)"
        ]
    };

    const statusColorMap = {
        "A1 - Anfrage/Idee": "green", "C1 - Umsetzung": "green", "B3 - Planung (Gate 1)": "green",
        "Z2 - Abgeschlossen": "green", "B2 - Auftragsklärung (Gate 1)": "green",
        "B5 - Genehmigt (Gate 2)": "green", "B4 - Empfohlen (Gate 1)": "green",
        "A2 - Bewertung (Gate 0)": "green", "B1 - Initiierung (Gate 1)": "green",
        "E1 - Abschluss": "yellow", "C2 - Abnahme": "yellow", "F1 - Revision": "yellow",
        "Z1 - Gestoppt/Zurückgestellt": "red", "Z3 - Abgelehnt": "red"
    };

    const finalizedStatuses = ["Z1 - Gestoppt/Zurückgestellt", "E1 - Abschluss", "C2 - Abnahme", "Z3 - Abgelehnt", "Z2 - Abgeschlossen"];

    let allProjects = [];

    fetch('/api/final-data')
        .then(res => res.json())
        .then(data => {
            allProjects = data.projects || [];
            populateDropdowns();
            renderProjects(allProjects);
        });

    document.addEventListener("DOMContentLoaded", () => {
        document.querySelectorAll(".filter-toggle").forEach(btn =>
            btn.addEventListener("click", () =>
                btn.parentElement.classList.toggle("active")
            )
        );

        document.querySelectorAll('.filter-group input[type="checkbox"]').forEach(cb =>
            cb.addEventListener('change', applyFilters)
        );

        document.getElementById('searchInput').addEventListener('input', e => {
            const query = e.target.value.toLowerCase().trim();
            const filtered = !query ? allProjects : allProjects.filter(p =>
                [p.name, p.number, p.projectLeaderId, p.statusId, p.typeId, p.priorityId].some(
                    val => val && val.toString().toLowerCase().includes(query)
                )
            );
            renderProjects(filtered);
        });

        document.querySelectorAll(".status-buttons button").forEach(button => {
            button.addEventListener("click", () => toggleStatus(button));
        });
    });

    function toggleStatus(button) {
        const status = button.dataset.status;
        const dashboardTitle = document.getElementById("dashboardTitle");
        const isActive = button.classList.toggle("active");

        document.querySelectorAll(".status-buttons button").forEach(btn => {
            if (btn !== button) btn.classList.remove("active");
        });

        dashboardTitle.textContent = isActive ? button.textContent : "Project Dashboard";
        const group = statusGroups[status];
        renderProjects(isActive ? allProjects.filter(p => group.includes(p.statusId)) : allProjects);
    }

    function renderProjects(projects) {
        const container = document.getElementById('projectCards');
        container.innerHTML = '';
        const today = new Date();

        projects.forEach(p => {
            const isExpired = new Date(p.end) < today;
            const isFinalized = finalizedStatuses.includes(p.statusId);
            const color = (isExpired && !isFinalized) ? "red" : (statusColorMap[p.statusId] || "gray");

            container.insertAdjacentHTML('beforeend', `
            <a href="project.html?number=${p.number}" class="card-link">
                <div class="card">
                    <div class="card-header">
                        <strong>${p.number || '-'}</strong><br />
                        Projektleiter: ${escapeHTML(p.projectLeaderId)}<br />
                        Status: ${escapeHTML(p.statusId)}<br />
                        Projektart: ${escapeHTML(p.typeId)}<br />
                        Priorität: ${escapeHTML(p.priorityId)}
                    </div>
                    <div class="card-title">${escapeHTML(p.name)}</div>
                    <div class="card-footer">${p.start} - ${p.end}</div>
                    <div class="progress-bar" style="background-color: ${color};"></div>
                </div>
            </a>
        `);
        });
    }

    function applyFilters() {
        const selectedProject = document.getElementById('projectFilter').value;
        const selectedLeader = document.getElementById('leaderFilter').value;

        const checked = Array.from(document.querySelectorAll('.filter-group input[type="checkbox"]:checked')).map(cb => cb.value);
        const statusFilters = checked.filter(v => ["On track", "Delayed", "Critical"].includes(v));
        const yearFilters = checked.filter(v => /^\d{4}$/.test(v)).map(Number);

        const today = new Date();

        const filtered = allProjects.filter(p => {
            const matchProject = !selectedProject || p.name === selectedProject;
            const matchLeader = !selectedLeader || p.projectLeaderId === selectedLeader;
            const startYear = new Date(p.start).getFullYear();
            const endYear = new Date(p.end).getFullYear();
            const isExpired = new Date(p.end) < today;
            const isFinalized = finalizedStatuses.includes(p.statusId);
            const isDelayed = isExpired && !isFinalized;
            const isValid = !isExpired;
            const color = isDelayed ? "red" : (statusColorMap[p.statusId] || "gray");

            const matchStatus = !statusFilters.length || (
                (statusFilters.includes("On track") && color === "green" && isValid) ||
                (statusFilters.includes("Critical") && ["yellow", "red"].includes(color) && isValid) ||
                (statusFilters.includes("Delayed") && isDelayed)
            );

            const matchYear = !yearFilters.length || yearFilters.some(y => startYear <= y && endYear >= y);

            return matchProject && matchLeader && matchStatus && matchYear;
        });

        renderProjects(filtered);
    }

    function populateDropdowns() {
        const projectSelect = document.getElementById('projectFilter');
        const leaderSelect = document.getElementById('leaderFilter');

        const projectNames = [...new Set(allProjects.map(p => p.name))].sort();
        const leaders = [...new Set(allProjects.map(p => p.projectLeaderId))].sort();

        projectNames.forEach(name => {
            projectSelect.insertAdjacentHTML('beforeend', `<option value="${name}">${name}</option>`);
        });

        leaders.forEach(name => {
            leaderSelect.insertAdjacentHTML('beforeend', `<option value="${name}">${name}</option>`);
        });

        projectSelect.addEventListener('change', applyFilters);
        leaderSelect.addEventListener('change', applyFilters);
    }

    function escapeHTML(str) {
        return String(str || '')
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#39;');
    }
</script>

</body>
</html>
